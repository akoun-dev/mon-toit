import { BarChart3, Users, Home, TrendingUp, TrendingDown, Eye, Clock, DollarSign, Activity, Download, Filter, Calendar, RefreshCw, ArrowUp, ArrowDown, Loader2 } from 'lucide-react';
import { MainLayout } from '@/components/layout/MainLayout';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { Progress } from '@/components/ui/progress';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { useState, useEffect } from 'react';
import adminDashboardService from '@/services/admin/AdminDashboardService';

const AdminAnalyticsPage = () => {
  // State pour les statistiques et chargement
  const [dashboardStats, setDashboardStats] = useState<any>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  // Charger les données du dashboard au montage
  useEffect(() => {
    const loadDashboardData = async () => {
      try {
        setLoading(true);
        setError(null);
        const { data, error } = await adminDashboardService.getDashboardStats();

        if (error) {
          console.error('Erreur dashboard analytics:', error);
          setError(error.message || 'Erreur de chargement');
        } else if (data) {
          setDashboardStats(data);
        }
      } catch (err) {
        console.error('Exception dashboard analytics:', err);
        setError('Erreur technique lors du chargement');
      } finally {
        setLoading(false);
      }
    };

    loadDashboardData();
  }, []); // Seulement au montage

  // Données mockées de secours si les vraies données ne chargent pas
  const analyticsStats = dashboardStats || {
    totalUsers: 12478,
    activeUsers: 8923,
    totalProperties: 4567,
    activeProperties: 3892,
    totalViews: 284765,
    avgSessionDuration: 245,
    conversionRate: 12.5,
    bounceRate: 32.8,
  };

  // Tendances mensuelles
  const monthlyTrends = [
    { month: 'Jan', users: 8923, properties: 3456, views: 198234, revenue: 2345678 },
    { month: 'Fév', users: 9234, properties: 3567, views: 205678, revenue: 2456789 },
    { month: 'Mar', users: 9567, properties: 3678, views: 212345, revenue: 2567890 },
    { month: 'Avr', users: 9892, properties: 3789, views: 224567, revenue: 2678901 },
    { month: 'Mai', users: 10234, properties: 3892, views: 237890, revenue: 2789012 },
    { month: 'Jun', users: 10567, properties: 4012, views: 245678, revenue: 2890123 }
  ];

  // Performances par segment
  const segmentPerformance = [
    {
      segment: 'Propriétaires',
      users: 2345,
      growth: 15.2,
      engagement: 78,
      revenue: 1234567
    },
    {
      segment: 'Locataires',
      users: 5678,
      growth: 8.7,
      engagement: 65,
      revenue: 567890
    },
    {
      segment: 'Agences',
      users: 890,
      growth: 22.1,
      engagement: 85,
      revenue: 890123
    },
    {
      segment: 'Visiteurs',
      users: 3565,
      growth: -5.3,
      engagement: 23,
      revenue: 123456
    }
  ];

  // Activité récente
  const recentActivity = [
    {
      id: 1,
      type: 'property_created',
      description: 'Nouveau bien publié',
      user: 'agence@mon-toit.ci',
      timestamp: 'Il y a 2 min',
      impact: 'high'
    },
    {
      id: 2,
      type: 'user_registered',
      description: 'Nouvel utilisateur inscrit',
      user: 'jean.dupont@email.com',
      timestamp: 'Il y a 5 min',
      impact: 'medium'
    },
    {
      id: 3,
      type: 'view_milestone',
      description: '1000 vues sur propriété',
      user: 'system',
      timestamp: 'Il y a 15 min',
      impact: 'low'
    }
  ];

  // Top des propriétés
  const topProperties = [
    {
      id: 1,
      title: 'Appartement F2 Cocody',
      views: 15234,
      favorites: 892,
      applications: 234,
      conversionRate: 1.54,
      status: 'active'
    },
    {
      id: 2,
      title: 'Studio Plateau',
      views: 12456,
      favorites: 678,
      applications: 189,
      conversionRate: 1.52,
      status: 'active'
    },
    {
      id: 3,
      title: 'Villa Riviera',
      views: 10987,
      favorites: 543,
      applications: 156,
      conversionRate: 1.42,
      status: 'active'
    }
  ];

  const getTrendIcon = (trend: number) => {
    return trend > 0 ?
      <ArrowUp className="h-4 w-4 text-green-500" /> :
      <ArrowDown className="h-4 w-4 text-red-500" />;
  };

  const getImpactBadge = (impact: string) => {
    const variants = {
      high: 'default',
      medium: 'secondary',
      low: 'outline'
    } as const;

    const labels = {
      high: 'Élevé',
      medium: 'Moyen',
      low: 'Faible'
    };

    return (
      <Badge variant={variants[impact as keyof typeof variants]}>
        {labels[impact as keyof typeof labels]}
      </Badge>
    );
  };

  const formatNumber = (num: number) => {
    return new Intl.NumberFormat('fr-FR').format(num);
  };

  // Afficher le spinner de chargement
  if (loading) {
    return (
      <MainLayout>
        <div className="flex items-center justify-center min-h-96">
          <div className="text-center">
            <Loader2 className="h-12 w-12 animate-spin text-primary mb-4" />
            <p className="text-lg font-medium text-gray-600">Chargement des statistiques...</p>
          </div>
        </div>
      </MainLayout>
    );
  }

  return (
    <MainLayout>
      <div className="container mx-auto p-6 space-y-6">
        {/* En-tête */}
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            <BarChart3 className="h-8 w-8 text-cyan-600" />
            <div>
              <h1 className="text-3xl font-bold">Analytics</h1>
              <p className="text-muted-foreground">Tableau de bord analytique de la plateforme</p>
            </div>
          </div>
          <div className="flex gap-2">
            <Select defaultValue="30days">
              <SelectTrigger className="w-[150px]">
                <SelectValue placeholder="Période" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="7days">7 jours</SelectItem>
                <SelectItem value="30days">30 jours</SelectItem>
                <SelectItem value="90days">90 jours</SelectItem>
                <SelectItem value="1year">1 an</SelectItem>
              </SelectContent>
            </Select>
            <Button variant="outline">
              <Download className="h-4 w-4 mr-2" />
              Exporter
            </Button>
            <Button>
              <RefreshCw className="h-4 w-4 mr-2" />
              Actualiser
            </Button>
          </div>
        </div>

        {/* Statistiques principales */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          <Card>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">Utilisateurs actifs</CardTitle>
              <Users className="h-4 w-4 text-muted-foreground" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">{formatNumber(analyticsStats.activeUsers)}</div>
              <div className="flex items-center gap-2 text-xs text-muted-foreground">
                <TrendingUp className="h-3 w-3 text-green-500" />
                <span>+12.5% ce mois</span>
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">Propriétés actives</CardTitle>
              <Home className="h-4 w-4 text-muted-foreground" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">{formatNumber(analyticsStats.activeProperties)}</div>
              <div className="flex items-center gap-2 text-xs text-muted-foreground">
                <TrendingUp className="h-3 w-3 text-green-500" />
                <span>+8.3% ce mois</span>
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">Vues totales</CardTitle>
              <Eye className="h-4 w-4 text-muted-foreground" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">{formatNumber(analyticsStats.totalViews)}</div>
              <div className="flex items-center gap-2 text-xs text-muted-foreground">
                <TrendingUp className="h-3 w-3 text-green-500" />
                <span>+15.2% ce mois</span>
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">Taux conversion</CardTitle>
              <Activity className="h-4 w-4 text-muted-foreground" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">{analyticsStats.conversionRate}%</div>
              <div className="flex items-center gap-2 text-xs text-muted-foreground">
                <TrendingUp className="h-3 w-3 text-green-500" />
                <span>+2.3% ce mois</span>
              </div>
            </CardContent>
          </Card>
        </div>

        <Tabs defaultValue="overview" className="space-y-4">
          <TabsList>
            <TabsTrigger value="overview">Vue d'ensemble</TabsTrigger>
            <TabsTrigger value="trends">Tendances</TabsTrigger>
            <TabsTrigger value="segments">Segments</TabsTrigger>
            <TabsTrigger value="properties">Top propriétés</TabsTrigger>
            <TabsTrigger value="activity">Activité</TabsTrigger>
          </TabsList>

          <TabsContent value="overview" className="space-y-4">
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <Card>
                <CardHeader>
                  <CardTitle>Métriques clés</CardTitle>
                  <CardDescription>
                    Indicateurs de performance principaux
                  </CardDescription>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div className="flex items-center justify-between">
                    <span>Durée moyenne de session</span>
                    <span className="font-medium">{analyticsStats.avgSessionDuration}s</span>
                  </div>
                  <div className="flex items-center justify-between">
                    <span>Taux de rebond</span>
                    <span className="font-medium">{analyticsStats.bounceRate}%</span>
                  </div>
                  <div className="flex items-center justify-between">
                    <span>Propriétés par utilisateur</span>
                    <span className="font-medium">
                      {(analyticsStats.totalProperties / analyticsStats.totalUsers).toFixed(2)}
                    </span>
                  </div>
                  <div className="flex items-center justify-between">
                    <span>Vues par propriété</span>
                    <span className="font-medium">
                      {Math.round(analyticsStats.totalViews / analyticsStats.totalProperties)}
                    </span>
                  </div>
                </CardContent>
              </Card>

              <Card>
                <CardHeader>
                  <CardTitle>Objectifs mensuels</CardTitle>
                  <CardDescription>
                    Progression vers les objectifs définis
                  </CardDescription>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div className="space-y-2">
                    <div className="flex items-center justify-between text-sm">
                      <span>Utilisateurs actifs</span>
                      <span className="font-medium">89%</span>
                    </div>
                    <Progress value={89} />
                  </div>
                  <div className="space-y-2">
                    <div className="flex items-center justify-between text-sm">
                      <span>Propriétés actives</span>
                      <span className="font-medium">76%</span>
                    </div>
                    <Progress value={76} />
                  </div>
                  <div className="space-y-2">
                    <div className="flex items-center justify-between text-sm">
                      <span>Taux conversion</span>
                      <span className="font-medium">94%</span>
                    </div>
                    <Progress value={94} />
                  </div>
                </CardContent>
              </Card>
            </div>
          </TabsContent>

          <TabsContent value="trends" className="space-y-4">
            <Card>
              <CardHeader>
                <CardTitle>Tendances mensuelles</CardTitle>
                <CardDescription>
                  Évolution des métriques sur 6 mois
                </CardDescription>
              </CardHeader>
              <CardContent>
                <div className="space-y-6">
                  <div>
                    <h4 className="font-medium mb-3">Utilisateurs</h4>
                    <div className="space-y-2">
                      {monthlyTrends.map((trend) => (
                        <div key={trend.month} className="flex items-center justify-between">
                          <span className="text-sm w-12">{trend.month}</span>
                          <div className="flex-1 mx-4">
                            <Progress value={(trend.users / 12000) * 100} />
                          </div>
                          <span className="text-sm font-medium w-16 text-right">
                            {formatNumber(trend.users)}
                          </span>
                        </div>
                      ))}
                    </div>
                  </div>

                  <div>
                    <h4 className="font-medium mb-3">Vues</h4>
                    <div className="space-y-2">
                      {monthlyTrends.map((trend) => (
                        <div key={trend.month} className="flex items-center justify-between">
                          <span className="text-sm w-12">{trend.month}</span>
                          <div className="flex-1 mx-4">
                            <Progress value={(trend.views / 300000) * 100} />
                          </div>
                          <span className="text-sm font-medium w-16 text-right">
                            {formatNumber(trend.views)}
                          </span>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              </CardContent>
            </Card>
          </TabsContent>

          <TabsContent value="segments" className="space-y-4">
            <Card>
              <CardHeader>
                <CardTitle>Performance par segment</CardTitle>
                <CardDescription>
                  Analyse détaillée par type d'utilisateur
                </CardDescription>
              </CardHeader>
              <CardContent>
                <div className="space-y-4">
                  {segmentPerformance.map((segment) => (
                    <div key={segment.segment} className="border rounded-lg p-4">
                      <div className="flex items-start justify-between">
                        <div className="flex-1">
                          <h4 className="font-semibold">{segment.segment}</h4>
                          <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mt-3 text-sm">
                            <div>
                              <p className="text-muted-foreground">Utilisateurs</p>
                              <p className="font-medium">{formatNumber(segment.users)}</p>
                            </div>
                            <div>
                              <p className="text-muted-foreground">Croissance</p>
                              <div className="flex items-center gap-2">
                                {getTrendIcon(segment.growth)}
                                <span className="font-medium">{segment.growth}%</span>
                              </div>
                            </div>
                            <div>
                              <p className="text-muted-foreground">Engagement</p>
                              <div className="flex items-center gap-2">
                                <Progress value={segment.engagement} className="w-12" />
                                <span className="font-medium">{segment.engagement}%</span>
                              </div>
                            </div>
                            <div>
                              <p className="text-muted-foreground">Revenus</p>
                              <p className="font-medium">{formatNumber(segment.revenue)} XOF</p>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </CardContent>
            </Card>
          </TabsContent>

          <TabsContent value="properties" className="space-y-4">
            <Card>
              <CardHeader>
                <CardTitle>Top des propriétés</CardTitle>
                <CardDescription>
                  Propriétés les plus performantes
                </CardDescription>
              </CardHeader>
              <CardContent>
                <div className="space-y-4">
                  {topProperties.map((property) => (
                    <div key={property.id} className="border rounded-lg p-4">
                      <div className="flex items-start justify-between">
                        <div className="flex-1">
                          <h4 className="font-semibold">{property.title}</h4>
                          <div className="flex items-center gap-4 mt-2 text-sm">
                            <div className="flex items-center gap-1">
                              <Eye className="h-4 w-4 text-blue-500" />
                              <span>{formatNumber(property.views)} vues</span>
                            </div>
                            <div className="flex items-center gap-1">
                              <Users className="h-4 w-4 text-red-500" />
                              <span>{property.favorites} favoris</span>
                            </div>
                            <div className="flex items-center gap-1">
                              <Activity className="h-4 w-4 text-green-500" />
                              <span>{property.applications} candidatures</span>
                            </div>
                          </div>
                          <div className="mt-2">
                            <div className="flex items-center gap-2">
                              <span className="text-sm text-muted-foreground">Conversion:</span>
                              <Progress value={property.conversionRate} className="w-20" />
                              <span className="text-sm font-medium">{property.conversionRate}%</span>
                            </div>
                          </div>
                        </div>
                        <Badge variant="outline" className="text-xs">
                          {property.status}
                        </Badge>
                      </div>
                    </div>
                  ))}
                </div>
              </CardContent>
            </Card>
          </TabsContent>

          <TabsContent value="activity" className="space-y-4">
            <Card>
              <CardHeader>
                <CardTitle>Activité récente</CardTitle>
                <CardDescription>
                  Événements notables de la plateforme
                </CardDescription>
              </CardHeader>
              <CardContent>
                <div className="space-y-3">
                  {recentActivity.map((activity) => (
                    <div key={activity.id} className="flex items-start justify-between p-3 border rounded-lg">
                      <div className="flex items-center gap-3">
                        <div className="w-2 h-2 bg-blue-500 rounded-full mt-2"></div>
                        <div>
                          <p className="font-medium">{activity.description}</p>
                          <div className="flex items-center gap-2 mt-1 text-sm">
                            <span className="text-muted-foreground">Par {activity.user}</span>
                            <span className="text-muted-foreground">• {activity.timestamp}</span>
                          </div>
                        </div>
                      </div>
                      {getImpactBadge(activity.impact)}
                    </div>
                  ))}
                </div>
              </CardContent>
            </Card>
          </TabsContent>
        </Tabs>
      </div>
    </MainLayout>
  );
};

export default AdminAnalyticsPage;