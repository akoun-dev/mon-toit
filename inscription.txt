# Workflow d'inscription - Plateforme Mon Toit

## Vue d'ensemble

La plateforme Mon Toit utilise un syst√®me d'inscription s√©curis√© avec v√©rification par email (OTP) et authentification multi-facteurs pour les administrateurs. Le workflow est con√ßu pour garantir la s√©curit√© tout en offrant une exp√©rience utilisateur fluide.

## üìã √âtapes du workflow d'inscription

### 1. Page d'authentification ([`Auth.tsx`](src/pages/Auth.tsx:1))

L'utilisateur acc√®de √† la page d'authentification qui propose deux onglets :
- **Connexion** : Pour les utilisateurs existants
- **Inscription** : Pour les nouveaux utilisateurs

#### Formulaire d'inscription
L'utilisateur doit fournir :
- **Nom complet** (validation : minimum 2 caract√®res)
- **Email** (validation : format email valide)
- **Mot de passe** (validation : 8 caract√®res minimum, 1 majuscule, 1 minuscule, 1 chiffre, 1 caract√®re sp√©cial)
- **Type de compte** : Locataire, Propri√©taire, Agence, ou Tiers de confiance

### 2. Processus d'inscription ([`useAuthEnhanced.tsx`](src/hooks/useAuthEnhanced.tsx:208))

Lors de la soumission du formulaire :

1. **Validation des donn√©es** avec sch√©ma Zod
2. **Cr√©ation du compte utilisateur** dans Supabase Auth
3. **G√©n√©ration automatique d'un code OTP** √† 6 chiffres
4. **Envoi du code par email** via le service OTP

#### M√©thodes d'inscription disponibles
- **Email/Mot de passe** : Flux standard avec OTP
- **OAuth** : Google, Facebook, Apple, Microsoft ([`OAuthButtons.tsx`](src/components/auth/OAuthButtons.tsx:1))

### 3. Syst√®me de v√©rification OTP

#### G√©n√©ration et stockage du code
- Le code est g√©n√©r√© via la fonction PostgreSQL [`create_otp_code()`](src/services/otpService.ts:67)
- Stock√© dans la table `otp_codes` avec :
  - Validit√© de 24 heures
  - Maximum 5 tentatives de v√©rification
  - Suivi des adresses IP et user agents

#### Envoi de l'email
- **D√©veloppement** : Utilise Mailpit ([`otpService.ts`](src/services/otpService.ts:202))
- **Production** : Utilise le service email de Supabase

L'email contient :
- Le code √† 6 chiffres format√© (XXX-XXX)
- Instructions claires
- Lien vers Mailpit en d√©veloppement

### 4. Page de confirmation ([`AuthConfirmation.tsx`](src/pages/AuthConfirmation.tsx:1))

Apr√®s l'inscription, l'utilisateur est redirig√© vers `/auth/confirmation?email=...`

#### Interface de v√©rification
- Champ pour saisir le code √† 6 chiffres
- Compteur de tentatives (maximum 5)
- Bouton de renvoi du code
- Instructions d√©taill√©es pour le d√©veloppement

#### Validation du code
1. V√©rification du format (6 chiffres)
2. Appel √† [`verifyOTP()`](src/hooks/useAuthEnhanced.tsx:481)
3. Confirmation de l'email dans Supabase
4. Redirection automatique vers le dashboard

### 5. Gestion des r√¥les et profils

#### Cr√©ation automatique du profil
Via le trigger PostgreSQL [`handle_new_user()`](supabase/migrations/20251023153000_create_profile_trigger.sql:7) :
- Cr√©ation du profil dans la table `profiles`
- Assignation du r√¥le par d√©faut dans `user_roles`
- Stockage des m√©tadonn√©es utilisateur

#### Types de r√¥les disponibles
- `locataire` : Recherche de logement
- `proprietaire` : Mise en location de biens
- `agence` : Gestion de portefeuille
- `tiers_de_confiance` : Interm√©diaire certifi√©
- `admin_ansut` : Administration plateforme

### 6. S√©curit√© renforc√©e

#### Authentification multi-facteurs (2FA)
- **Obligatoire pour les administrateurs** ([`Auth.tsx`](src/pages/Auth.tsx:203))
- Utilise TOTP (Time-based One-Time Password)
- Codes de r√©cup√©ration disponibles
- Rate limiting des tentatives

#### Rate limiting
- **Login** : Maximum 5 tentatives par 15 minutes
- **OTP** : Maximum 5 tentatives de v√©rification
- **2FA** : Limitation apr√®s √©checs r√©p√©t√©s

### 7. Flux OAuth (optionnel)

Pour les utilisateurs choisissant l'authentification via providers tiers :

1. **Redirection vers le provider** ([`AuthCallback.tsx`](src/pages/AuthCallback.tsx:1))
2. **Callback et traitement** des donn√©es
3. **Cr√©ation automatique du profil** si inexistant
4. **Assignation des r√¥les** appropri√©s
5. **Redirection vers le dashboard**

## üîß Points techniques importants

### D√©veloppement vs Production
- **D√©veloppement** : Force syst√©matiquement le processus OTP m√™me pour les comptes locaux
- **Production** : Utilise le flux standard de Supabase avec confirmation email

### Base de donn√©es
- Tables principales : `profiles`, `user_roles`, `otp_codes`, `otp_notifications`
- Row Level Security (RLS) activ√© sur toutes les tables
- Triggers automatiques pour la cr√©ation de profils

### Logging et monitoring
- Toutes les tentatives d'authentification sont logg√©es
- Suivi des adresses IP et fingerprints
- M√©triques de succ√®s/√©chec disponibles

## üì± Exp√©rience utilisateur

### Messages d'instruction clairs
- Guides √©tape par √©tape
- Indicateurs visuels de progression
- Messages d'erreur explicites

### Support du d√©veloppement
- Instructions Mailpit int√©gr√©es
- Codes de test disponibles
- Debug mode activable

### Accessibilit√©
- Formulaires correctement √©tiquet√©s
- Retours d'erreur clairs
- Navigation au clavier support√©e

Ce workflow d'inscription garantit un √©quilibre optimal entre s√©curit√© n√©cessaire pour une plateforme immobili√®re certifi√©e et exp√©rience utilisateur fluide pour les diff√©rents types d'utilisateurs (locataires, propri√©taires, agences et tiers de confiance).



  ‚òí V√©rifier la configuration de l'API locale
     ‚òí Cr√©er un compte test avec curl
     ‚òê Corriger le probl√®me de r√©cursion RLS
     ‚òê Cr√©er un compte via l'interface web
     ‚òê V√©rifier la g√©n√©ration et envoi du code OTP
     ‚òê Tester la validation du code OTP